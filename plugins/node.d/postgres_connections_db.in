#!@@PERL@@
# -*- perl -*-

=head1 NAME

postgres_connections_db - Plugin to monitor number of PostgreSQL database
connections per database.

=head1 CONFIGURATION

For configuration information, see Munin::Plugins::PgSQL

=head1 AUTHOR

Magnus Hagander

=head1 LICENSE

GPL, put more text here :-)

=cut

use strict;
use warnings;
use DBI;

use Munin::Plugin::Pgsql;

my $pg = Munin::Plugin::Pgsql->new(
        title=>'PostgreSQL connections per database',
        info=>'Number of connections per database',
        vlabel=>'Connections',
        basequery=>"SELECT pg_database.datname,COALESCE(count,0) AS count FROM pg_database LEFT JOIN (SELECT datname,count(*) FROM pg_stat_activity WHERE procpid != pg_backend_pid() GROUP BY datname) AS tmp ON pg_database.datname=tmp.datname ORDER BY 1",
        configquery=>"SELECT datname,datname FROM pg_database WHERE datallowconn ORDER BY 1",
);

$pg->Process();

