#!@@GOODSH@@
# -*- sh -*-

: << =cut

=head1 NAME

exim_mailqueue - Plugin to monitor exim queue size

=head1 CONFIGURATION

Configuration parameters for /etc/munin/plugin-conf.d/exim_mailqueue,
if you need to override the defaults below:

[exim_mailqueue]
 env.spooldir  - Override what exim says
 env.exim      - Where's exim?
 env.queuewarn - When to warn
 env.queuecrit - When to crit

=head2 DEFAULT CONFIGURATION

[exim_mailqueue]
 env.spooldir  <autodetected>
 env.exim      <autodetected>
 env.queuewarn 100
 env.queuecrit 200

=head1 AUTHOR

Unknown author

=head1 LICENSE

Unknown license

=head1 MAGIC MARKERS

=begin comment

These magic markers are used by munin-node-configure when installing
munin-node.

=end comment

 #%# family=auto
 #%# capabilities=autoconf

=cut

DIRNAME=$(dirname $0)
SPOOLDIR="unset"
# You cannot trust the exit status of which
EXIM=$(which exim 2>/dev/null)
case $EXIM:$? in
    *:1|no*) EXIM=$(which exim4 2>/dev/null)
esac
case $EXIM:$? in
    *:1|no*) EXIM=''
esac

GRAPHTITLE='Exim Mailqueue'

SPOOLDIR=${spooldir:-unset}
EXIM=${exim:-unset}
QUEUEWARN=${queuewarn:-100}
QUEUECRIT=${queuecrit:-200}
GRAPHTITLE=${graphtitle:-$GRAPHTITLE}

if [ "$SPOOLDIR" = "unset" ]
then
	SPOOLDIR=$( ($EXIM -bP spool_directory | awk '{ print $3 "/input" }') 2>/dev/null)
fi

if [ "$1" = "autoconf" ]; then
    if [ -z "$EXIM" ]; then
	echo no
	exit 0
    fi
	
	if $EXIM -bV 2>/dev/null >/dev/null; then
		if ( /usr/bin/find $SPOOLDIR -iname "*-H" -print 2>/dev/null >/dev/null ); then
			echo yes
			exit 0
		else
			if [ $? -eq 1 ]; then
				echo "no (permission denied on spooldir)"
				exit 0
			else
				echo "no"
				exit 0
			fi
		fi
	else
		if [ $? -eq 127 ]
		then
			echo "no (exim not found)"
			exit 0
		else
			echo no
			exit 0
		fi
	fi
fi

if [ "$1" = "config" ]; then
        if [ ! -z $SPOOLDIR ];then
	echo "graph_title $GRAPHTITLE"
	echo 'graph_args --base 1000 -l 0'
	echo 'graph_vlabel mails in queue'
	echo 'graph_category exim'
	echo 'mails.label mails'
	echo 'mails.draw AREA'
	echo "mails.warning $QUEUEWARN"
	echo "mails.critical $QUEUECRIT"
	fi;
	exit 0
fi

printf "mails.value "
/usr/bin/find $SPOOLDIR -iname "*-H" -print 2>/dev/null |wc -l | sed 's/ *//'
