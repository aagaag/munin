#!@@GOODSH@@
# -*- sh -*-

: << =cut

=head1 NAME

fw_forwarded_local - Plugin to monitor network connections.

=head1 CONFIGURATION

This plugin must run with root privileges

=head1 CONFIGURATION EXAMPLE

@@CONFDIR@@/plugin-conf.d/global or other file in that dir must contain:

 [fw*]
  user root

=head1 NOTES

#  forward: number of connections forwarder
#  local:   number of connections for the host itself

=head1 MAGIC MARKERS

 #%# family=auto
 #%# capabilities=autoconf


=cut

if [ "$1" = "autoconf" ]; then
	if ( cat /proc/net/ip_conntrack 2>/dev/null >/dev/null ); then
		echo yes
		exit 0
	else
		if [ $? -eq 127 ]
		then
			echo "no (ipconntrack not found)"
			exit 0
		else
			echo no
			exit 0
		fi
	fi
fi

if [ "$1" = "config" ]; then

	echo 'graph_title ipconntrack'
	echo 'graph_args -l 0 --base 1000'
	echo 'graph_vlabel established connections'
	echo 'graph_category network'
	echo 'forward.label forward'
	echo 'forward.type GAUGE'
	echo 'local.label local'
	echo 'local.type GAUGE'
	exit 0
fi

perl -ne '
    BEGIN { $forward=0; $local=0; }

    if ( ($src, $dst, $isrc, $idst) =
     /.*ESTABLISHED src=(.*) .*dst=(.*) sport.*src=(.*) .*dst=(.*) sport.*/ ) {
        if( $src eq $idst) {
	    $local++;
	} else {
            $forward++;
       }
    }
    END { print "forward.value $forward\nlocal.value $local\n" }
' </proc/net/ip_conntrack

