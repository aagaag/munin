#!@@GOODSH@@
# -*- sh -*-

: << =cut

=head1 NAME

threads - Plugin to monitor the number of threads on Linux

=head1 CONFIGURATION

No configuration

=head1 AUTHOR

Lars Strand

=head1 LICENSE

GNU GPL

=head1 MAGIC MARKERS

 #%# family=auto
 #%# capabilities=autoconf

=cut

if [ "$1" = "autoconf" ]; then
    grep -q '^Threads' /proc/$$/status && echo "yes" || echo "no"
    exit 0
fi

if [ "$1" = "config" ]; then
    echo 'graph_title Number of threads'
    #echo 'graph_args --base 1000 -l 0 '
    echo 'graph_vlabel number of threads'
    echo 'graph_category processes'
    echo 'graph_info This graph shows the number of threads.'
    echo 'threads.label threads'
    echo 'threads.draw LINE2'
    echo 'threads.info The current number of threads.'
    exit 0
fi

echo -n "threads.value "
find /proc -maxdepth 1 -name '[1-9]*' -exec grep 'Threads' {}/status \; | awk ' { sum += $2; } END { print sum; }'
# Alternate command:
#ps --no-headers axm | grep '^    -' | wc -l
